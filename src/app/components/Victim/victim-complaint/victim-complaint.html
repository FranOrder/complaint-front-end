<main class="ms-sm-auto px-md-4 py-4">
    <div class="row">
        <div class="col-12">
            <div class="welcome-header p-4 d-flex flex-column flex-md-row justify-content-between align-items-center lh-lg">
                <div>
                    <h2 class="fw-bold">Denuncia segura y confidencial</h2>
                    <p class="mb-0" style="font-size: 18px;">
                        Completa los datos mínimos necesarios. Puedes guardar y salir cuando quieras. En emergencia, llama al 100 o 105.
                    </p>
                    <small class="d-block mt-2 fst-italic text-danger">
                        <i class="bi bi-lock-fill"></i>
                        Cifrado extremo a extremo. Tus datos solo los verán profesionales autorizadas.
                    </small>
                </div>
                 <button class="btn btn-outline-secondary" type="button" [routerLink]="['/victim/map']" [queryParams]="{from: 'complaint'}">¿A donde puedo ir?</button>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="d-flex gap-3 mb-4 flex-wrap">
                <span class="badge rounded-pill p-2" [ngClass]="{'bg-primary text-white': currentStep === 1, 'text-bg-light text-secondary': currentStep !== 1}" style="font-size: 1rem;">
                    1. Datos del Hecho
                </span>
                <span class="badge rounded-pill p-2" [ngClass]="{'bg-primary text-white': currentStep === 2, 'text-bg-light text-secondary': currentStep !== 2}" style="font-size: 1rem;">
                    2. Datos del Agresor
                </span>
                <span class="badge rounded-pill p-2" [ngClass]="{'bg-primary text-white': currentStep === 3, 'text-bg-light text-secondary': currentStep !== 3}" style="font-size: 1rem;">
                    3. Evidencias
                </span>
            </div>
            <div class="p-4" style="background-color: #faf7ff; border-radius: 0.5rem; padding: 10px;">
            
                <p class="mb-3 text-secondary fw-bold">Paso {{currentStep}} de 3</p>

            <form [formGroup]="complaintForm" (ngSubmit)="onSubmit()">
                <!-- Step 1: Datos del Hecho -->
                <div class="p-4 form-step-container" *ngIf="currentStep === 1">
                    <h4 class="fw-bold mb-3">Detalles del incidente</h4>
                    <p class="text-secondary mb-4">Dinos cuándo y dónde ocurrió el incidente.</p>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="incidentDate" class="form-label fw-bold">Fecha del incidente (<span class="text-danger">*</span>)</label>
                            <input 
                                type="date" 
                                class="form-control" 
                                id="incidentDate" 
                                formControlName="incidentDate"
                                [class.is-invalid]="isFieldInvalid('incidentDate')">
                            <div *ngIf="isFieldInvalid('incidentDate')" class="invalid-feedback">
                                <div *ngIf="f['incidentDate'].errors?.['required']">La fecha del incidente es requerida</div>
                                <div *ngIf="f['incidentDate'].errors?.['futureDate']">La fecha del incidente no puede ser futura</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="incidentLocation" class="form-label fw-bold">Lugar del incidente</label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="incidentLocation" 
                                formControlName="incidentLocation" 
                                placeholder="Ej. Parque Kennedy, Su vivienda, Trabajo, etc.">
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <label for="violenceType" class="form-label fw-bold">Tipo de violencia</label>
                            <select 
                                class="form-select" 
                                id="violenceType" 
                                formControlName="violenceType"
                                [class.is-invalid]="isFieldInvalid('violenceType')">
                                <option value="" selected disabled>Selecciona una opción</option>
                                <option value="PHYSICAL">Física</option>
                                <option value="PSYCHOLOGICAL">Psicológica</option>
                                <option value="EMOTIONAL">Emocional</option>
                                <option value="SEXUAL">Sexual</option>
                                <option value="ECONOMIC">Económica</option>
                                <option value="DIGITAL">Digital</option>
                                <option value="OTHER">Otra</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="description" class="form-label fw-bold">Descripción del hecho (<span class="text-danger">*</span>)</label>
                        <textarea 
                            class="form-control" 
                            id="description" 
                            formControlName="description" 
                            rows="6" 
                            placeholder="Detalle libre del incidente. ¿Qué pasó exactamente?"
                            [class.is-invalid]="isFieldInvalid('description')"></textarea>
                        <div class="d-flex justify-content-between">
                            <small class="form-text text-secondary">
                                Sé lo más específica posible. Mínimo 20 caracteres.
                            </small>
                            <small class="character-count" 
                                   [class.text-danger]="f['description'].value?.length < 20">
                                {{ f['description'].value?.length || 0 }}/2000
                            </small>
                        </div>
                        <div *ngIf="isFieldInvalid('description')" class="invalid-feedback">
                            <div *ngIf="f['description'].errors?.['required']">La descripción es requerida</div>
                            <div *ngIf="f['description'].errors?.['minlength']">La descripción debe tener al menos 20 caracteres</div>
                            <div *ngIf="f['description'].errors?.['maxlength']">La descripción no puede exceder los 2000 caracteres</div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" class="btn btn-primary-custom" (click)="nextStep()" [disabled]="!complaintForm.get('incidentDate')?.valid || !complaintForm.get('description')?.valid">
                            Siguiente (Datos del Agresor)
                        </button>
                    </div>
                </div>
                <!-- Step 2: Datos del Agresor -->
                <div class="p-4 form-step-container" *ngIf="currentStep === 2">
                    <h4 class="fw-bold mb-3">Datos del Agresor</h4>
                    <p class="text-secondary mb-4">Registra quién es la persona agresora. Solo se permite un registro.</p>
                    
                    <div class="border p-3 mb-4 bg-white rounded">
                        <h6 class="fw-bold text-dark mb-3">Información del Agresor</h6>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="aggressorFullName" class="form-label fw-bold">Nombre completo del agresor (<span class="text-danger">*</span>)</label>
                                <input type="text" class="form-control" id="aggressorFullName" formControlName="aggressorFullName" required placeholder="Nombre completo o alias"
                                       [class.is-invalid]="isFieldInvalid('aggressorFullName')">
                                <div *ngIf="isFieldInvalid('aggressorFullName')" class="invalid-feedback">
                                    <div *ngIf="f['aggressorFullName'].errors?.['required']">El nombre del agresor es requerido</div>
                                    <div *ngIf="f['aggressorFullName'].errors?.['minlength']">El nombre debe tener al menos 2 caracteres</div>
                                    <div *ngIf="f['aggressorFullName'].errors?.['maxlength']">El nombre no puede exceder los 200 caracteres</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="aggressorRelationship" class="form-label fw-bold">Relación con la víctima (<span class="text-danger">*</span>)</label>
                                <select class="form-select" id="aggressorRelationship" formControlName="aggressorRelationship"
                                        [class.is-invalid]="isFieldInvalid('aggressorRelationship')">
                                    <option value="" disabled selected>Selecciona la relación</option>
                                    <option value="PARTNER">Pareja actual</option>
                                    <option value="EX_PARTNER">Ex pareja</option>
                                    <option value="FAMILY">Familiar</option>
                                    <option value="STRANGE">Desconocido</option>
                                    <option value="OTHER">Otro</option>
                                </select>
                                <div *ngIf="isFieldInvalid('aggressorRelationship')" class="invalid-feedback">
                                    <div *ngIf="f['aggressorRelationship'].errors?.['required']">La relación con el agresor es requerida</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="aggressorAdditionalDetails" class="form-label fw-bold">Detalles adicionales</label>
                            <textarea class="form-control" id="aggressorAdditionalDetails" formControlName="aggressorAdditionalDetails" rows="3" 
                                      placeholder="Vive cerca, trabaja contigo, usa un vehículo..."
                                      [class.is-invalid]="isFieldInvalid('aggressorAdditionalDetails')"></textarea>
                            <div *ngIf="isFieldInvalid('aggressorAdditionalDetails')" class="invalid-feedback">
                                <div *ngIf="f['aggressorAdditionalDetails'].errors?.['maxlength']">Los detalles no pueden exceder los 1000 caracteres</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2 justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" (click)="prevStep()">Anterior (Datos del Hecho)</button>
                        <button type="button" class="btn btn-primary-custom" (click)="nextStep()" [disabled]="!complaintForm.get('aggressorFullName')?.valid">
                            Siguiente (Evidencias)
                        </button>
                    </div>
                </div>
                <!-- Step 3: Evidencias -->
                <div class="p-4 form-step-container" *ngIf="currentStep === 3">
                    <h4 class="fw-bold mb-3">Evidencias o Pruebas</h4>
                    <p class="text-secondary mb-4">Adjunta archivos que apoyen tu denuncia (fotos, videos, audios, documentos).</p>
                    
                    <div class="mb-4">
                        <label for="evidenceUpload" class="form-label fw-bold">Subir evidencia</label>
                        <input class="form-control" type="file" id="evidenceUpload" (change)="onFileSelected($event)" multiple>
                        <small class="form-text text-secondary">
                            Formatos permitidos: .jpg, .png, .mp4, .pdf. Máximo 10MB por archivo.
                        </small>
                    </div>
                    
                    <div class="mb-4">
                        <h6 class="fw-bold">Archivos cargados ({{ selectedFiles.length || 0 }})</h6>
                        <ul class="list-group">
                            <li *ngFor="let file of selectedFiles" class="list-group-item d-flex justify-content-between align-items-center">
                                <i class="bi bi-file-earmark-text me-2"></i> {{ file.name }}
                                <button type="button" class="btn-close" (click)="removeFile(file)"></button>
                            </li>
                            <li *ngIf="!selectedFiles.length" class="list-group-item d-flex justify-content-between align-items-center text-secondary">
                                <i class="bi bi-file-earmark-text me-2"></i> No has adjuntado archivos aún.
                            </li>
                        </ul>
                    </div>
                    
                    <div class="d-flex gap-2 justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" (click)="prevStep()">Anterior (Datos del Agresor)</button>
                        <button 
                            type="submit" 
                            class="btn btn-primary-custom" 
                            [disabled]="complaintForm.invalid || isSubmitting"
                            [class.opacity-50]="complaintForm.invalid || isSubmitting">
                            <span *ngIf="!isSubmitting">Enviar denuncia</span>
                            <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span *ngIf="isSubmitting" class="ms-2">Enviando...</span>
                        </button>
                    </div>
                </div>
            </form></div>
        </div>
        <div class="col-lg-4 mt-4 mt-lg-0">
            <div class="card p-4 align-items-center lh-lg justify-content-center" style="border: none; background-color: #e6daf5; border-radius: 0.5rem; margin-bottom: 10px;">
                <div class="card p-4 align-items-center lh-lg justify-content-center mb-4" style="background-color: #faf7ff; border-radius: 0.5rem; padding: 10px;">
                    <h4 class="fw-bold mb-3">Ayuda rápida</h4>
                    <p class="mb-1 fw-bold text-danger fs-5">Emergencias: 100 o 105</p>
                    <ul class="list-unstyled mb-0 lh-lg">
                        <li><i class="bi bi-arrow-right"></i> Busca puntos de ayuda cercanos en el mapa</li>
                        <li><i class="bi bi-arrow-right"></i> Modo discreto: cierra esta pestaña si alguien entra.</li>
                    </ul>
                </div>
                <button class="btn btn-light mb-4 py-2" style="background-color: white; border: 1px solid #b497bd; color: #b497bd; display: block; margin: 0 auto; padding: 80px;"type="button" [routerLink]="['/victim/info']" [queryParams]="{from: 'complaint'}">
                    <span class="fw-bold">Información útil</span>
                </button>
                <div class="alert text-center fw-bold text-white" role="alert" style="background-color: rgb(245, 198, 112); border: none;">
                    Tu información se guarda automáticamente de forma segura.
                </div>
            </div>
        </div>
    </div>
</main>